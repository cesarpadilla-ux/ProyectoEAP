<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Vessel View - Monitor en Vivo</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  /* --- Estilos (Simplificados para brevedad) --- */
  :root {
    --bg-body: #f8f9fa; --bg-card: #ffffff; --text-primary: #1f2937;
    --accent-color: #059669; --border-color: #e2e8f0;
    --font-ui: 'Segoe UI', sans-serif; --font-mono: 'Consolas', monospace;
  }
  body { background: var(--bg-body); color: var(--text-primary); font-family: var(--font-ui); margin: 0; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
  
  /* Header */
  header { background: rgba(255,255,255,0.95); border-bottom: 1px solid var(--border-color); height: 60px; display: flex; align-items: center; justify-content: space-between; padding: 0 20px; }
  .brand { font-weight: 700; text-transform: uppercase; font-size: 1.1rem; }
  .brand span { color: var(--accent-color); }
  .csv-btn { background: var(--text-primary); color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 0.8rem; }
  .csv-btn:hover { background: #000; }

  /* Layout */
  .main-container { display: flex; height: calc(100vh - 60px); }
  .menu { width: 220px; background: white; border-right: 1px solid var(--border-color); padding: 20px 10px; display: flex; flex-direction: column; gap: 5px; }
  .menu button { padding: 10px; border: none; background: transparent; text-align: left; cursor: pointer; color: #64748b; border-radius: 6px; }
  .menu button.active { background: rgba(5,150,105,0.1); color: var(--accent-color); font-weight: 700; }
  
  .content { flex: 1; padding: 20px; overflow-y: auto; }
  
  /* Cards */
  .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 20px; }
  .card { background: white; padding: 15px; border-radius: 8px; border: 1px solid var(--border-color); box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
  h2 { font-size: 0.9rem; margin: 0 0 10px 0; border-bottom: 1px solid #eee; padding-bottom: 8px; display: flex; justify-content: space-between; }
  
  .chart-container { position: relative; height: 250px; width: 100%; }
  
  /* Info Bar */
  .info-bar { display: flex; gap: 20px; margin-bottom: 20px; background: white; padding: 10px 20px; border-radius: 8px; border: 1px solid var(--border-color); font-size: 0.9rem; }
  .info-item b { display: block; font-size: 0.7rem; color: #94a3b8; text-transform: uppercase; }
</style>
</head>
<body>

<header>
  <div class="brand">Vessel <span>View</span></div>
  <button onclick="downloadCSV()" class="csv-btn">⬇ Exportar Historial Completo</button>
</header>

<div class="main-container">
  <div class="menu">
    <button onclick="showPanel('all_view', this)" class="active">Resumen General</button>
    <button onclick="showPanel('ecg_view', this)">ECG Detalle</button>
    <button onclick="showPanel('ppg_view', this)">PPG Detalle</button>
  </div>

  <div class="content">
    <div class="info-bar">
       <div class="info-item"><b>Estado</b><span id="status">Esperando datos...</span></div>
       <div class="info-item"><b>Tiempo Transcurrido</b><span id="timeDisplay">0.0 s</span></div>
       <div class="info-item"><b>Muestras Totales</b><span id="samplesDisplay">0</span></div>
    </div>

    <div id="all_view" class="panel">
      <div class="dashboard-grid">
        <div class="card"><h2>ECG</h2><div class="chart-container"><canvas id="c_ecg"></canvas></div></div>
        <div class="card"><h2>PPG Ind Izq</h2><div class="chart-container"><canvas id="c_ppg1"></canvas></div></div>
        <div class="card"><h2>PPG Ind Der</h2><div class="chart-container"><canvas id="c_ppg2"></canvas></div></div>
        <div class="card"><h2>PPG Pie Izq</h2><div class="chart-container"><canvas id="c_ppg3"></canvas></div></div>
        <div class="card"><h2>PPG Pie Der</h2><div class="chart-container"><canvas id="c_ppg4"></canvas></div></div>
      </div>
    </div>

    <div id="ecg_view" class="panel" style="display:none;">
       <div class="card" style="height: 500px;"><h2>ECG Pantalla Completa</h2><div class="chart-container" style="height: 100%;"><canvas id="c_ecg_full"></canvas></div></div>
    </div>
    <div id="ppg_view" class="panel" style="display:none;">
       <div class="card"><h2>Monitor PPG (4 Canales)</h2><p>Ver resumen general para gráficas individuales.</p></div>
    </div>

  </div>
</div>

<script>
const FIREBASE_URL = 'https://practicumii-a9956-default-rtdb.firebaseio.com/ad7606.json';
const SAMPLE_RATE = 200;
const WINDOW_SECONDS = 15;
const WINDOW_SAMPLES = SAMPLE_RATE * WINDOW_SECONDS; // 3000

// Aquí acumularemos TODO el historial para el CSV
let localHistory = { CH1: [], CH2: [], CH3: [], CH4: [], CH5: [] };

let charts = {};

function showPanel(id, btn) {
  document.querySelectorAll('.panel').forEach(p => p.style.display = 'none');
  document.getElementById(id).style.display = 'block';
  document.querySelectorAll('.menu button').forEach(b => b.classList.remove('active'));
  if(btn) btn.classList.add('active');
}

// Inicializar gráficas
function initChart(id, color) {
    const ctx = document.getElementById(id).getContext('2d');
    return new Chart(ctx, {
        type: 'line',
        data: { labels: [], datasets: [{ data: [], borderColor: color, borderWidth: 1.5, pointRadius: 0, tension: 0.1 }] },
        options: {
            responsive: true, maintainAspectRatio: false, animation: false,
            plugins: { legend: { display: false } },
            scales: {
                x: { ticks: { color: '#666', maxTicksLimit: 10 }, grid: { display: false }, title: {display: true, text: 'Tiempo (s)'} },
                y: { ticks: { color: '#666' }, grid: { color: '#f0f0f0' } }
            }
        }
    });
}

charts['c_ecg']  = initChart('c_ecg', '#0ea5e9'); // Azul
charts['c_ppg1'] = initChart('c_ppg1', '#22c55e'); // Verde
charts['c_ppg2'] = initChart('c_ppg2', '#eab308'); // Amarillo
charts['c_ppg3'] = initChart('c_ppg3', '#f97316'); // Naranja
charts['c_ppg4'] = initChart('c_ppg4', '#ef4444'); // Rojo
charts['c_ecg_full'] = initChart('c_ecg_full', '#0ea5e9');

async function updateData() {
    try {
        const res = await fetch(FIREBASE_URL);
        const fb = await res.json();
        if (!fb) return;

        // 1. OBTENER INFORMACIÓN DE TIEMPO
        // 'fb.total' es el número total de muestras que ha procesado la Raspberry
        const totalSamplesServer = fb.total || 0;
        const currentLocalLength = localHistory.CH1.length;

        document.getElementById('samplesDisplay').innerText = totalSamplesServer;
        document.getElementById('status').innerText = "Recibiendo datos...";
        
        // 2. SINCRONIZAR DATOS (Acumular en localHistory)
        // Si el servidor tiene más datos que nosotros, calculamos cuántos nos faltan
        if (totalSamplesServer > currentLocalLength) {
            const newSamplesCount = totalSamplesServer - currentLocalLength;
            
            // Tomamos los últimos 'newSamplesCount' del buffer que envió Firebase
            // (El buffer de FB tiene máx 3000, así que si nos atrasamos mucho perderemos datos, 
            // pero con 0.5s de update y buffer de 15s, estamos seguros).
            
            const channelKeys = ["CH1","CH2","CH3","CH4","CH5"];
            channelKeys.forEach(ch => {
                const bufferRemoto = fb[ch] || [];
                // Extraer solo lo nuevo
                const chunk = bufferRemoto.slice(-newSamplesCount); 
                // Agregarlo a nuestro historial local
                localHistory[ch].push(...chunk);
            });
        }

        // 3. CALCULAR EJE DE TIEMPO "DESLIZANTE"
        // El tiempo final es el total de muestras / 200
        const endTime = totalSamplesServer / SAMPLE_RATE;
        document.getElementById('timeDisplay').innerText = endTime.toFixed(1) + " s";

        // El tiempo inicial de la gráfica es (Final - 15s), pero no menor a 0
        let startTime = endTime - WINDOW_SECONDS;
        if (startTime < 0) startTime = 0;

        // 4. PREPARAR DATOS PARA VISUALIZAR (Solo últimos 3000 puntos)
        // Usamos slice(-3000) sobre el historial local que ya tenemos sincronizado
        const sliceStart = Math.max(0, localHistory.CH1.length - WINDOW_SAMPLES);
        
        const dataToView = {
            CH1: localHistory.CH1.slice(sliceStart),
            CH2: localHistory.CH2.slice(sliceStart),
            CH3: localHistory.CH3.slice(sliceStart),
            CH4: localHistory.CH4.slice(sliceStart),
            CH5: localHistory.CH5.slice(sliceStart)
        };

        // Generar etiquetas de tiempo correctas (Ej: 15.1, 15.2 ... 30.0)
        // El primer punto de 'dataToView' corresponde al tiempo 'startTime'
        const labels = [];
        for (let i = 0; i < dataToView.CH1.length; i++) {
            labels.push((startTime + (i / SAMPLE_RATE)).toFixed(1));
        }

        // 5. RENDERIZAR
        const updateChart = (id, data) => {
            if(charts[id]) {
                charts[id].data.labels = labels;
                charts[id].data.datasets[0].data = data;
                charts[id].update();
            }
        };

        updateChart('c_ecg', dataToView.CH1);
        updateChart('c_ppg1', dataToView.CH2);
        updateChart('c_ppg2', dataToView.CH3);
        updateChart('c_ppg3', dataToView.CH4);
        updateChart('c_ppg4', dataToView.CH5);
        updateChart('c_ecg_full', dataToView.CH1);

    } catch (e) {
        console.error("Error update:", e);
    }
}

function downloadCSV() {
    if (localHistory.CH1.length === 0) { alert("Sin datos"); return; }
    let csv = "Time(s),ECG,PPG_Ind_Izq,PPG_Ind_Der,PPG_Pie_Izq,PPG_Pie_Der\n";
    
    for (let i = 0; i < localHistory.CH1.length; i++) {
        const t = (i / SAMPLE_RATE).toFixed(3);
        csv += `${t},${localHistory.CH1[i]},${localHistory.CH2[i]},${localHistory.CH3[i]},${localHistory.CH4[i]},${localHistory.CH5[i]}\n`;
    }
    
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = "registro_completo_" + Date.now() + ".csv";
    a.click();
}

// Actualizar cada 500ms
setInterval(updateData, 500);
</script>
</body>
</html>